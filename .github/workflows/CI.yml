name: build and test feature branch (nodejs minimal)

on:
  pull_request:
    branches: [develop]
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: read

jobs:
  build-feature:
    name: Install & sanity checks (feature branch)
    runs-on: ubuntu-latest
    steps:
      #############################################################
      # 1- Checkout code from feature branch
      #############################################################
      - name: Checkout feature branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      #############################################################
      # 2- Setup Node.js
      #############################################################
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'   # ajusta si necesitas otra versión
          cache: 'npm'

      #############################################################
      # 3- Cache node modules (complementario)
      #############################################################
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-

      #############################################################
      # 4- Install dependencies
      #############################################################
      - name: Install dependencies
        run: |
          if [ -f pnpm-lock.yaml ]; then
            corepack enable
            corepack prepare pnpm@latest --activate
            pnpm install --frozen-lockfile
          elif [ -f yarn.lock ] && [ -f package.json ]; then
            npm install -g yarn
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      #############################################################
      # 5- Sanity: mostrar versiones
      #############################################################
      - name: Show environment
        run: |
          node -v
          npm -v
          echo "Files in repo root:"
          ls -la

      #############################################################
      # 6- Run tests ONLY if package.json tiene un script 'test' distinto al valor por defecto
      #############################################################
      # - name: Run tests (if defined and not the default failing script)
      #   run: |
      #     # Detectar si package.json contiene el script de test por defecto (el que imprime "Error: no test specified")
      #     if grep -q '"test": "echo \"Error: no test specified\" && exit 1"' package.json; then
      #       echo "No hay tests definidos (script 'test' es el placeholder por defecto). Se omite paso de tests."
      #     else
      #       echo "Se detectó script 'test' en package.json. Ejecutando tests..."
      #       npm test
      #     fi

  #######################################################
  # Automatic merge to develop branch (si build-feature OK)
  #######################################################
  merge-feature-into-develop:
    name: Merge feature into develop
    runs-on: ubuntu-latest
    needs: build-feature
    if: ${{ success() && github.event.pull_request.head.repo.full_name == github.repository }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      ########################################################
      # 1- Checkout develop branch (fetch full history)
      ########################################################
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      ########################################################
      # 2- Configure git user
      ########################################################
      - name: Configure git
        run: |
          git config user.email "workflow-bot@example.com"
          git config user.name "workflow-bot"

      ########################################################
      # 3- Merge feature branch into develop
      ########################################################
      - name: Merge feature into develop
        run: |
          # Asegurarse de poder obtener la rama fuente
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git fetch origin +refs/heads/${{ github.event.pull_request.head.ref }}:refs/remotes/origin/${{ github.event.pull_request.head.ref }}
          git merge --no-ff --no-edit origin/${{ github.event.pull_request.head.ref }} || {
            echo "Merge conflict or merge failed"; exit 1;
          }

      ########################################################
      # 4- Push changes after merge
      ########################################################
      - name: Push merge to develop
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.base_ref }}

      ########################################################
      # 5- Optional: Trigger downstream workflow (repository_dispatch)
      ########################################################
      - name: Trigger publish artifact workflow
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: publish-artifact-event
          client-payload: '{"base_branch": "${{ github.base_ref }}", "source_pr": "${{ github.event.number }}"}'

  #######################################################
  # Notificación de Slack después del merge (opcional)
  #######################################################
  slack-notification:
      name: Send Slack Notification
      runs-on: ubuntu-latest
      needs: merge-feature-into-develop # Se ejecuta después del job de merge
      if: ${{ always() }} # Siempre se ejecuta para notificar éxito o fallo
      steps:
        - name: Notify Slack
          uses: Ilshidur/action-slack@v3
          with:
            webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
            msg: |
              :rocket: **Merge to develop complete!**
              *Pull Request*: <${{ github.event.pull_request.html_url }}|#${{ github.event.number }} - ${{ github.event.pull_request.title }}>
              *Source branch*: `${{ github.event.pull_request.head.ref }}`
              *Target branch*: `${{ github.base_ref }}`
            # Icono y nombre de usuario para el mensaje
            slack-username: 'GitHub Actions Bot'
            slack-icon-emoji: ':github:'